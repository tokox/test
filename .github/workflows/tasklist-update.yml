name: Tasklist Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  tasklist_update:
    name: Update tasklist
    runs-on: ubuntu-latest
    container: fedora:latest

    steps:
      - name: Setup environment
        run: echo "DATE=$(date -u +'%Y-%m-%d %H:%M')" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          dnf install -y 'dnf-command(config-manager)'
          dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
          dnf install -y git python3 gh

      - name: Setup tools
        run:  |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
          gh auth setup-git
          git config --global --add safe.directory /__w/test/test

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR
        id: check_pr
        run: |
          tmp="$(mktemp)"
          gh pr list -s open -H tasklist-update -l auto-tasklist-update --json number --jq .[].number > $tmp
          cnt="$(wc -l $tmp | cut -f1 -d' ')"
          if [[ $cnt -gt 1 ]]; then
            exit 1
          elif [[ $cnt -eq 1 ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tasklist branch
        if: ${{ ! fromJSON(steps.check_pr.outputs.exists) }}
        run: |
          git checkout -B tasklist-update
          git push -u origin tasklist-update -f
      
      - name: Checkout tasklist branch
        if: ${{ fromJSON(steps.check_pr.outputs.exists) }}
        run: git checkout tasklist-update
      
      - name: Run update
        id: update
        run: python3 scripts/update_tasklist

      - name: Get bot details
        id: bot_details
        uses: raven-actions/bot-details@v1.0.1

      - name: Create PR
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: README.md
          commit-message: "tasklist update -> ${{ env.DATE }}\n\nupdated: ${{ steps.update.outputs.updated }}\nadded: ${{ steps.update.outputs.added }}\ndeleted: ${{ steps.update.outputs.deleted }}\n"
          committer: ${{ steps.bot_details.outputs.name-email }}
          author: ${{ steps.bot_details.outputs.name-email }}
          branch: tasklist-update
          delete-branch: true
          base: main
          title: "Automatic tasklist update -> ${{ env.DATE }}"
          body: "This is an automatic tasklist update by the tasklist-update workflow."
          labels: auto-tasklist-update
          assignees: tokox
          reviewers: tokox
      
      - name: Print result
        run: echo "PR \#${{ steps.create_pr.outputs.pull-request-number }} was ${{ steps.create_pr.outputs.pull-request-operation }} at ${{ steps.create_pr.outputs.pull-request-url }}"
